import{a1 as y,j as e,r as j,Y as R,C as D,B as q,W as F,a2 as ee,a3 as $,p as k,F as W,a4 as ie,o as Y,a5 as G,a6 as z,q as K,s as le,a7 as re,L as ce,a8 as de,M as pe,a9 as me,m as he,n as ue}from"./chakra-4d1cedbe.js";import{d as O,L as I,S as A,f as X,u as P,g as ge,h as fe,i as je,e as ne,j as xe,r as H,k as ve,a as Ce,l as ye,m as Me,n as be,o as we,p as te,q as Se,t as Le,v as Ne,w,R as ze,x as Ie}from"./index-e86f816f.js";import{a as U,u as ke,b as se,I as ae,G as Oe,E as Re}from"./use-templates-ce2cbd78.js";import{u as M,r as x,l as Ee}from"./react-d5c86316.js";function Be(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}}]})(a)}function Te(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"}}]})(a)}function He(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"}}]})(a)}function _(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}}]})(a)}function Fe(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"}}]})(a)}function Ae(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"}}]})(a)}function Pe(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"}}]})(a)}function Ue(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}}]})(a)}function Je(a){return y({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}}]})(a)}function oe(a){const{optionalName:n,onChange:i}=a,{t:r}=M(),d=U(),h=(t,s)=>[{type:"select",label:r("Language"),value:t,options:Object.entries(I).reduce((o,f)=>({...o,[f[0]]:d(f[1])}),{}),disabledOptions:Object.keys(I).filter(o=>A.includes(o)||n.some(f=>f[0]===o)).filter(o=>o!==t),onChange:o=>m(t,o)},{type:"input",label:r("Name"),value:s,onChange:o=>c(t,o),validator:o=>!!o}],l=()=>{const t=Object.keys(I).filter(s=>!A.includes(s)&&!n.some(o=>o[0]===s));t.includes("ko")?i([...n,["ko",""]]):i([...n,[t[0],""]])},m=(t,s)=>{i(n.map(o=>o[0]===t?[s,o[1]]:o))},c=(t,s)=>{i(n.map(o=>o[0]===t?[o[0],s]:o))},g=t=>{i(n.filter(s=>s[0]!==t))};return e.jsxs(e.Fragment,{children:[n.length===0&&e.jsx(j,{variant:"ghost",size:"sm",leftIcon:e.jsx(_,{}),onClick:l,w:"100%",my:2,children:r("Add more translations")}),n.map(([t,s],o,f)=>e.jsxs(R,{sx:{w:"100%","& > div:first-of-type":{flex:1}},children:[e.jsx(O,{fields:h(t,s),noLabel:o>0}),o===f.length-1?e.jsx(D,{size:"sm",variant:"ghost","aria-label":r("Add translation"),title:r("Add translation"),onClick:l,icon:e.jsx(_,{})}):e.jsx(q,{minW:8}),e.jsx(D,{size:"sm",variant:"ghost","aria-label":r("Remove this translation"),title:r("Remove this translation"),onClick:()=>g(t),icon:e.jsx(Be,{})})]},t))]})}function Ve(){const{t:a}=M(),n=U(),i=X(),{company:r,newCompany:d,companyName:h,companyOptionalName:l}=P(t=>t.ticket),m=ke(),c=[{type:"select",label:a("Company"),value:r,options:{...m,[a("New")]:{new:a("Add a company...")}},disabledOptions:[""],onChange:t=>i(ge(t))},{type:"input",label:a("Company code"),placeholder:"e.g. mtr, gzmtr, shmetro",value:d,onChange:t=>i(fe(t)),hidden:r!=="new"}],g=A.map(t=>({type:"input",label:n(I[t]),value:h[t],onChange:s=>i(je({lang:t,name:s}))}));return e.jsxs(q,{as:"section",children:[e.jsx(F,{as:"h5",size:"sm",mb:2,children:a("Railway company")}),e.jsxs(ne,{direction:"column",children:[e.jsx(O,{fields:c}),r==="new"&&e.jsx(O,{fields:g}),r==="new"&&e.jsx(oe,{optionalName:l,onChange:t=>i(xe(t))})]})]})}const Ge=a=>new Promise(n=>{const i=new FileReader;i.onloadend=()=>n(i.result),i.readAsText(a)}),De={position:"relative","& > div":{overflow:"hidden"},"& > div:last-of-type":{flex:1,alignItems:"center",justifyContent:"center",minW:120,"& input":{display:"none"}}};function We(a){const{company:n,templateEntry:i,onLineChange:r,onNewLineChange:d,onMajorFlagChange:h,onLineNameChange:l,onOptionalNameChange:m,onParamChange:c,onParamImport:g,onRemove:t}=a,{line:s,newLine:o,majorUpdate:f,templateName:b,optionalName:S,param:E}=i,{t:u}=M(),B=U(),{templates:J}=se(n),T=x.useRef(null),L=async p=>{var Q;const C=(Q=p.target.files)==null?void 0:Q[0];if(console.log("handleFileUpload():: received file",C),!!C){if(C.type!=="application/json"){alert("Invalid file type!"),p.target.value="";return}try{const Z=await Ge(C);c(JSON.parse(Z))}catch(Z){alert("Invalid file!"),p.target.value=""}}},V={"":u("Please select..."),...n===""||n==="new"?{}:J.reduce((p,C)=>({...p,[C.filename]:B(C.name)}),{}),new:u("Add a line...")},v=[{type:"select",label:u("Line"),value:s,options:V,disabledOptions:[""],onChange:p=>r(p),minW:150},{type:"input",label:u("Line code"),placeholder:"e.g. twl, gz1, sh1",value:o,onChange:p=>d(p),hidden:s!=="new"},{type:"switch",label:u("Major update"),isChecked:f,onChange:p=>h(p),hidden:s==="new",oneLine:!0}],N=A.map(p=>({type:"input",label:B(I[p]),value:b[p],onChange:C=>l(p,C)}));return e.jsxs(ne,{sx:De,children:[e.jsx(D,{size:"sm",variant:"ghost",icon:e.jsx(Je,{}),"aria-label":u("Remove this line"),title:u("Remove this line"),position:"absolute",top:0,right:0,zIndex:5,onClick:t}),e.jsxs(ee,{spacing:0,children:[e.jsx(O,{fields:[...v,...N],minW:110}),e.jsx(oe,{optionalName:S,onChange:m})]}),e.jsx(ee,{children:E?e.jsxs(e.Fragment,{children:[e.jsx($,{as:Ae,boxSize:10}),e.jsxs(k,{as:"i",fontSize:"xs",children:["(",u("Size"),": ",JSON.stringify(E).length," ",u("chars"),")"]}),e.jsx(j,{size:"sm",onClick:()=>c(void 0),children:u("Remove")})]}):e.jsxs(e.Fragment,{children:[e.jsx(k,{as:"i",fontSize:"sm",children:u("Import from")}),e.jsxs(R,{spacing:1,children:[e.jsx(j,{size:"sm",onClick:g,children:"RMG"}),e.jsx(j,{size:"sm",onClick:()=>{var p;return(p=T.current)==null?void 0:p.click()},children:u("Local")}),e.jsx("input",{ref:T,type:"file",accept:".json",onChange:L})]})]})})]})}const _e="rmg-bridge--",qe={h:500,maxH:"70%","& iframe":{h:"100%",w:"100%"}};function $e(a){const{templateId:n,onClose:i,onImport:r}=a,[d]=x.useState(crypto.randomUUID()),h="/rmg/#/import?"+new URLSearchParams({parentComponent:H.getAppName(),parentId:d});return x.useEffect(()=>{const l=new BroadcastChannel(_e+d);return l.onmessage=m=>{const{event:c,data:g}=m.data;console.log("[rmg-templates] Received event from RMG app clip:",c),c==="CLOSE"?i():c==="IMPORT"&&r(g)},()=>{l.close()}},[n]),e.jsx(ve,{isOpen:!!n,onClose:i,sx:qe,children:e.jsx("iframe",{src:h,loading:"lazy"})})}function Ye(){const{t:a}=M(),n=X(),{company:i,templates:r}=P(t=>t.ticket),{templates:d,isLoading:h}=se(i),[l,m]=x.useState(),c=(t,s)=>{const o=d.find(f=>f.filename===s);n(Ne({id:t,line:s,name:o==null?void 0:o.name}))},g=t=>{l&&n(te({id:l,param:t})),m(void 0)};return e.jsxs(q,{as:"section",mt:3,position:"relative",children:[h&&e.jsx(Ce,{isIndeterminate:!0}),e.jsxs(W,{children:[e.jsx(F,{as:"h5",size:"sm",mb:2,children:a("Add or update templates")}),e.jsx(ie,{hasArrow:!0,label:a("Toggling on 'Major update' will update the uploader field of the template and you are required enter extra justification for it."),children:e.jsx("span",{children:e.jsx($,{as:Te,ml:1})})})]}),r.map(t=>e.jsx(We,{company:i,templateEntry:t,onLineChange:s=>c(t.id,s),onNewLineChange:s=>n(ye({id:t.id,newLine:s})),onMajorFlagChange:s=>n(Me({id:t.id,majorUpdate:s})),onLineNameChange:(s,o)=>n(be({id:t.id,lang:s,name:o})),onOptionalNameChange:s=>n(we({id:t.id,optionalName:s})),onParamChange:s=>n(te({id:t.id,param:s})),onParamImport:()=>m(t.id),onRemove:()=>n(Se(t.id))},t.id)),e.jsx(R,{justifyContent:"flex-end",children:e.jsx(j,{variant:"ghost",size:"sm",leftIcon:e.jsx(_,{}),onClick:()=>n(Le()),children:a("Add item")})}),e.jsx($e,{templateId:l,onClose:()=>m(void 0),onImport:g})]})}function Ke(a){const{companyErrors:n,templateErrors:i,onClose:r}=a,{t:d}=M(),h=U();return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(k,{children:d("Your inputs contain the following errors. Please fix it before submitting.")}),n.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(F,{as:"h5",size:"sm",my:2,children:d("Railway company")}),e.jsx(G,{"aria-label":"List of company errors",children:n.map((l,m)=>e.jsx(z,{children:h(ae[l])},m))})]}),Object.values(i).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(F,{as:"h5",size:"sm",my:2,children:d("Templates")}),e.jsx(G,{"aria-label":"List of template errors",children:Object.entries(i).map(([l,m])=>e.jsxs(z,{children:[l,e.jsx(G,{children:m.map((c,g)=>e.jsx(z,{children:h(ae[c])},g))})]},l))})]})]}),e.jsx(K,{children:e.jsx(R,{children:e.jsx(j,{colorScheme:"primary",onClick:r,children:d("Go back")})})})]})}function Xe(a){const{justification:n,majorUpdateJustifications:i,onJustificationChange:r,onMajorUpdateJustificationChange:d,onNext:h}=a,{t:l}=M(),m=[{type:"textarea",value:n,label:l("Justification"),placeholder:l("Briefly describe your changes and provide justification"),onChange:r}],c=Object.entries(i).map(([t,s])=>({type:"textarea",value:s,label:l("Justification for major update of")+" "+t,placeholder:l("Briefly describe your changes and provide justification"),onChange:o=>d(t,o)})),g=!n||Object.values(i).some(t=>!t);return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(k,{children:l("Please provide suitable source and justification.")}),e.jsx(O,{fields:[...m,...c],minW:"full"})]}),e.jsx(K,{children:e.jsx(j,{colorScheme:"primary",onClick:h,rightIcon:e.jsx(Ue,{}),isDisabled:g,children:l("Next")})})]})}function Qe(a){var f;const{companyName:n,companyBlock:i,templateBlocks:r,justification:d,majorUpdateJustifications:h,onPrev:l,onClose:m}=a,{t:c}=M(),g=le("primary.500","primary.300"),t=[`**Justification:** ${d||"(REPLACE ME)"}`,Object.entries(h).map(([b,S])=>`- Major update of ${b}: ${S}`).join(`
`),Oe,(f=i==null?void 0:i.outerHTML)!=null?f:"",...r.map(b=>b.outerHTML)].join(`

`),s=new URLSearchParams({template:"new-templates-request.md",label:"resources",title:"Resources: New templates of "+n}),o=async()=>{await navigator.clipboard.writeText(t)};return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(k,{children:c("Follow the instructions below to open an Issue")+":"}),e.jsxs(re,{children:[e.jsxs(z,{children:[c("Open")," ",e.jsxs(ce,{color:g,href:"https://github.com/railmapgen/rmg-templates/issues/new?"+s.toString(),isExternal:!0,children:["Issue: New Templates Request ",e.jsx($,{as:He})]})]}),e.jsxs(z,{children:[c("Click copy button and paste into issue body")," ",e.jsx(j,{size:"xs",leftIcon:e.jsx(Fe,{}),onClick:o,children:c("Copy")})]})]})]}),e.jsxs(K,{children:[e.jsx(j,{variant:"ghost",onClick:l,mr:"auto",leftIcon:e.jsx(Pe,{}),children:c("Previous")}),e.jsx(j,{colorScheme:"primary",onClick:m,children:c("Close")})]})]})}function Ze(a){const{isOpen:n,onClose:i}=a,{t:r}=M(),[d,h]=x.useState([]),[l,m]=x.useState({}),[c,g]=x.useState(""),[t,s]=x.useState({}),[o,f]=x.useState(!1),{coreCompanyConfig:b,otherCompanyConfig:S,templateList:E}=P(v=>v.app),u=P(v=>v.ticket),B=w.getCompanyEnglishName(u,[...b,...S]),J=w.getCompanyBlock(u),T=w.getTemplateBlocks(u);x.useEffect(()=>{if(n){h(w.getCompanyErrors(u)),m(w.getTemplateErrors(u));const v=w.getMajorUpdateNames(u,E).reduce((N,p)=>({...N,[p]:""}),{});s(v)}else g(""),s({}),f(!1)},[n]);const L=d.length>0||Object.values(l).flat().length>0,V=!L&&!o;return e.jsxs(de,{blockScrollOnMount:!1,isOpen:n,onClose:i,scrollBehavior:"inside",children:[e.jsx(pe,{}),e.jsxs(me,{children:[e.jsx(he,{children:r("Submit templates")}),e.jsx(ue,{}),L&&e.jsx(Ke,{companyErrors:d,templateErrors:l,onClose:i}),V&&e.jsx(Xe,{justification:c,majorUpdateJustifications:t,onJustificationChange:g,onMajorUpdateJustificationChange:(v,N)=>s(p=>({...p,[v]:N})),onNext:()=>f(!0)}),!L&&o&&e.jsx(Qe,{companyName:B,companyBlock:J,templateBlocks:T,justification:c,majorUpdateJustifications:t,onPrev:()=>f(!1),onClose:i})]})]})}const et={px:2,pt:2,width:{base:"100%",md:520},"& > div:first-of-type":{flexDirection:"column",flex:1,overflowY:"auto"},"& > div:nth-of-type(2)":{my:2}};function ot(){const{t:a}=M(),n=Ee(),i=X(),[r,d]=x.useState(!1),h=()=>{H.isStandaloneWindow()?n("/"):H.openApp("rmg-templates")},l=()=>{i(Ie()),H.event(Re.RESET_TICKETS,{})};return e.jsxs(ze,{sx:et,children:[e.jsxs(W,{children:[e.jsx(Ve,{}),e.jsx(Ye,{})]}),e.jsxs(W,{children:[e.jsx(j,{size:"sm",onClick:h,children:a("Back to list")}),e.jsxs(R,{ml:"auto",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:l,children:a("Reset")}),e.jsx(j,{size:"sm",colorScheme:"primary",onClick:()=>d(!0),children:a("Submit")})]})]}),e.jsx(Ze,{isOpen:r,onClose:()=>d(!1)})]})}export{ot as default};
