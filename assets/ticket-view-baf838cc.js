import{a0 as M,j as e,t as j,Y as T,E as D,B as q,X as A,a1 as ee,a2 as $,r as O,F as _,a3 as ie,q as Y,a4 as G,a5 as k,s as X,v as le,a6 as re,L as ce,a7 as de,M as pe,a8 as me,o as he,p as ue}from"./chakra-46f9f9eb.js";import{b as R,L as E,S as P,e as K,a as B,f as ge,g as fe,h as je,i as ne,j as xe,r as F,k as ve,l as Ce,m as ye,n as Me,o as be,p as Se,q as te,t as we,v as Le,w as ze,x as L,d as Ne,y as Ie}from"./index-20d12b30.js";import{u as U,a as se,I as ae,G as ke,E as Ee}from"./use-templates-81ad1f75.js";import{u as b,r as x,l as Oe}from"./react-a3ff4964.js";function Re(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}}]})(n)}function Be(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"}}]})(n)}function Te(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"}}]})(n)}function W(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}}]})(n)}function He(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"}}]})(n)}function Fe(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"}}]})(n)}function Ae(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"}}]})(n)}function Pe(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}}]})(n)}function Ue(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}}]})(n)}function oe(n){const{optionalName:s,onChange:i}=n,{t:r}=b(),d=U(),m=(a,o)=>[{type:"select",label:r("Language"),value:a,options:Object.entries(E).reduce((t,p)=>({...t,[p[0]]:d(p[1])}),{}),disabledOptions:Object.keys(E).filter(t=>P.includes(t)||s.some(p=>p[0]===t)).filter(t=>t!==a),onChange:t=>h(a,t)},{type:"input",label:r("Name"),value:o,onChange:t=>c(a,t),validator:t=>!!t}],l=()=>{const a=Object.keys(E).filter(o=>!P.includes(o)&&!s.some(t=>t[0]===o));a.includes("ko")?i([...s,["ko",""]]):i([...s,[a[0],""]])},h=(a,o)=>{i(s.map(t=>t[0]===a?[o,t[1]]:t))},c=(a,o)=>{i(s.map(t=>t[0]===a?[t[0],o]:t))},u=a=>{i(s.filter(o=>o[0]!==a))};return e.jsxs(e.Fragment,{children:[s.length===0&&e.jsx(j,{variant:"ghost",size:"sm",leftIcon:e.jsx(W,{}),onClick:l,w:"100%",my:2,children:r("Add more translations")}),s.map(([a,o],t,p)=>e.jsxs(T,{sx:{w:"100%","& > div:first-of-type":{flex:1}},children:[e.jsx(R,{fields:m(a,o),noLabel:t>0}),t===p.length-1?e.jsx(D,{size:"sm",variant:"ghost","aria-label":r("Add translation"),title:r("Add translation"),onClick:l,icon:e.jsx(W,{})}):e.jsx(q,{minW:8}),e.jsx(D,{size:"sm",variant:"ghost","aria-label":r("Remove this translation"),title:r("Remove this translation"),onClick:()=>u(a),icon:e.jsx(Re,{})})]},a))]})}function Je(){const{t:n,i18n:s}=b(),i=U(),r=K(),{companyConfig:d}=B(t=>t.app),{company:m,newCompany:l,companyName:h,companyOptionalName:c}=B(t=>t.ticket),u={...d.map(t=>[t.id,i(t.name)]).sort((t,p)=>t[1].localeCompare(p[1],s.languages[0])).reduce((t,p)=>({...t,[p[0]]:p[1]}),{"":n("Please select...")}),new:n("Add a company...")},a=[{type:"select",label:n("Company"),value:m,options:u,disabledOptions:[""],onChange:t=>r(ge(t))},{type:"input",label:n("Company code"),placeholder:"e.g. mtr, gzmtr, shmetro",value:l,onChange:t=>r(fe(t)),hidden:m!=="new"}],o=P.map(t=>({type:"input",label:i(E[t]),value:h[t],onChange:p=>r(je({lang:t,name:p}))}));return e.jsxs(q,{as:"section",children:[e.jsx(A,{as:"h5",size:"sm",mb:2,children:n("Railway company")}),e.jsxs(ne,{direction:"column",children:[e.jsx(R,{fields:a}),m==="new"&&e.jsx(R,{fields:o}),m==="new"&&e.jsx(oe,{optionalName:c,onChange:t=>r(xe(t))})]})]})}const Ve=n=>new Promise(s=>{const i=new FileReader;i.onloadend=()=>s(i.result),i.readAsText(n)}),Ge={position:"relative","& > div":{overflow:"hidden"},"& > div:last-of-type":{flex:1,alignItems:"center",justifyContent:"center",minW:120,"& input":{display:"none"}}};function De(n){const{company:s,templateEntry:i,onLineChange:r,onNewLineChange:d,onMajorFlagChange:m,onLineNameChange:l,onOptionalNameChange:h,onParamChange:c,onParamImport:u,onRemove:a}=n,{line:o,newLine:t,majorUpdate:p,templateName:S,optionalName:z,param:v}=i,{t:f}=b(),H=U(),{templates:J}=se(s),w=x.useRef(null),V=async g=>{var Q;const y=(Q=g.target.files)==null?void 0:Q[0];if(console.log("handleFileUpload():: received file",y),!!y){if(y.type!=="application/json"){alert("Invalid file type!"),g.target.value="";return}try{const Z=await Ve(y);c(JSON.parse(Z))}catch(Z){alert("Invalid file!"),g.target.value=""}}},C={"":f("Please select..."),...s===""||s==="new"?{}:J.reduce((g,y)=>({...g,[y.filename]:H(y.name)}),{}),new:f("Add a line...")},N=[{type:"select",label:f("Line"),value:o,options:C,disabledOptions:[""],onChange:g=>r(g),minW:150},{type:"input",label:f("Line code"),placeholder:"e.g. twl, gz1, sh1",value:t,onChange:g=>d(g),hidden:o!=="new"},{type:"switch",label:f("Major update"),isChecked:p,onChange:g=>m(g),hidden:o==="new",oneLine:!0}],I=P.map(g=>({type:"input",label:H(E[g]),value:S[g],onChange:y=>l(g,y)}));return e.jsxs(ne,{sx:Ge,children:[e.jsx(D,{size:"sm",variant:"ghost",icon:e.jsx(Ue,{}),"aria-label":f("Remove this line"),title:f("Remove this line"),position:"absolute",top:0,right:0,zIndex:5,onClick:a}),e.jsxs(ee,{spacing:0,children:[e.jsx(R,{fields:[...N,...I],minW:110}),e.jsx(oe,{optionalName:z,onChange:h})]}),e.jsx(ee,{children:v?e.jsxs(e.Fragment,{children:[e.jsx($,{as:Fe,boxSize:10}),e.jsxs(O,{as:"i",fontSize:"xs",children:["(",f("Size"),": ",JSON.stringify(v).length," ",f("chars"),")"]}),e.jsx(j,{size:"sm",onClick:()=>c(void 0),children:f("Remove")})]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{as:"i",fontSize:"sm",children:f("Import from")}),e.jsxs(T,{spacing:1,children:[e.jsx(j,{size:"sm",onClick:u,children:"RMG"}),e.jsx(j,{size:"sm",onClick:()=>{var g;return(g=w.current)==null?void 0:g.click()},children:f("Local")}),e.jsx("input",{ref:w,type:"file",accept:".json",onChange:V})]})]})})]})}const _e="rmg-bridge--",We={h:500,maxH:"70%","& iframe":{h:"100%",w:"100%"}};function qe(n){const{templateId:s,onClose:i,onImport:r}=n,[d]=x.useState(crypto.randomUUID()),m="/rmg/import?"+new URLSearchParams({parentComponent:F.getAppName(),parentId:d});return x.useEffect(()=>{const l=new BroadcastChannel(_e+d);return l.onmessage=h=>{const{event:c,data:u}=h.data;console.log("[rmg-templates] Received event from RMG app clip:",c),c==="CLOSE"?i():c==="IMPORT"&&r(u)},()=>{l.close()}},[s]),e.jsx(ve,{isOpen:!!s,onClose:i,sx:We,children:e.jsx("iframe",{src:m,loading:"lazy"})})}function $e(){const{t:n}=b(),s=K(),{company:i,templates:r}=B(a=>a.ticket),{templates:d,isLoading:m}=se(i),[l,h]=x.useState(),c=(a,o)=>{const t=d.find(p=>p.filename===o);s(ze({id:a,line:o,name:t==null?void 0:t.name}))},u=a=>{l&&s(te({id:l,param:a})),h(void 0)};return e.jsxs(q,{as:"section",mt:3,position:"relative",children:[m&&e.jsx(Ce,{isIndeterminate:!0}),e.jsxs(_,{children:[e.jsx(A,{as:"h5",size:"sm",mb:2,children:n("Add or update templates")}),e.jsx(ie,{hasArrow:!0,label:n("Toggling on 'Major update' will update the uploader field of the template and you are required enter extra justification for it."),children:e.jsx("span",{children:e.jsx($,{as:Be,ml:1})})})]}),r.map(a=>e.jsx(De,{company:i,templateEntry:a,onLineChange:o=>c(a.id,o),onNewLineChange:o=>s(ye({id:a.id,newLine:o})),onMajorFlagChange:o=>s(Me({id:a.id,majorUpdate:o})),onLineNameChange:(o,t)=>s(be({id:a.id,lang:o,name:t})),onOptionalNameChange:o=>s(Se({id:a.id,optionalName:o})),onParamChange:o=>s(te({id:a.id,param:o})),onParamImport:()=>h(a.id),onRemove:()=>s(we(a.id))},a.id)),e.jsx(T,{justifyContent:"flex-end",children:e.jsx(j,{variant:"ghost",size:"sm",leftIcon:e.jsx(W,{}),onClick:()=>s(Le()),children:n("Add item")})}),e.jsx(qe,{templateId:l,onClose:()=>h(void 0),onImport:u})]})}function Ye(n){const{companyErrors:s,templateErrors:i,onClose:r}=n,{t:d}=b(),m=U();return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(O,{children:d("Your inputs contain the following errors. Please fix it before submitting.")}),s.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{as:"h5",size:"sm",my:2,children:d("Railway company")}),e.jsx(G,{"aria-label":"List of company errors",children:s.map((l,h)=>e.jsx(k,{children:m(ae[l])},h))})]}),Object.values(i).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(A,{as:"h5",size:"sm",my:2,children:d("Templates")}),e.jsx(G,{"aria-label":"List of template errors",children:Object.entries(i).map(([l,h])=>e.jsxs(k,{children:[l,e.jsx(G,{children:h.map((c,u)=>e.jsx(k,{children:m(ae[c])},u))})]},l))})]})]}),e.jsx(X,{children:e.jsx(T,{children:e.jsx(j,{colorScheme:"primary",onClick:r,children:d("Go back")})})})]})}function Xe(n){const{justification:s,majorUpdateJustifications:i,onJustificationChange:r,onMajorUpdateJustificationChange:d,onNext:m}=n,{t:l}=b(),h=[{type:"textarea",value:s,label:l("Justification"),placeholder:l("Briefly describe your changes and provide justification"),onChange:r}],c=Object.entries(i).map(([a,o])=>({type:"textarea",value:o,label:l("Justification for major update of")+" "+a,placeholder:l("Briefly describe your changes and provide justification"),onChange:t=>d(a,t)})),u=!s||Object.values(i).some(a=>!a);return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(O,{children:l("Please provide suitable source and justification.")}),e.jsx(R,{fields:[...h,...c],minW:"full"})]}),e.jsx(X,{children:e.jsx(j,{colorScheme:"primary",onClick:m,rightIcon:e.jsx(Pe,{}),isDisabled:u,children:l("Next")})})]})}function Ke(n){var p;const{companyName:s,companyBlock:i,templateBlocks:r,justification:d,majorUpdateJustifications:m,onPrev:l,onClose:h}=n,{t:c}=b(),u=le("primary.500","primary.300"),a=[`**Justification:** ${d||"(REPLACE ME)"}`,Object.entries(m).map(([S,z])=>`- Major update of ${S}: ${z}`).join(`
`),ke,(p=i==null?void 0:i.outerHTML)!=null?p:"",...r.map(S=>S.outerHTML)].join(`

`),o=new URLSearchParams({template:"new-templates-request.md",label:"resources",title:"Resources: New templates of "+s}),t=async()=>{await navigator.clipboard.writeText(a)};return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(O,{children:c("Follow the instructions below to open an Issue")+":"}),e.jsxs(re,{children:[e.jsxs(k,{children:[c("Open")," ",e.jsxs(ce,{color:u,href:"https://github.com/railmapgen/rmg-templates/issues/new?"+o.toString(),isExternal:!0,children:["Issue: New Templates Request ",e.jsx($,{as:Te})]})]}),e.jsxs(k,{children:[c("Click copy button and paste into issue body")," ",e.jsx(j,{size:"xs",leftIcon:e.jsx(He,{}),onClick:t,children:c("Copy")})]})]})]}),e.jsxs(X,{children:[e.jsx(j,{variant:"ghost",onClick:l,mr:"auto",leftIcon:e.jsx(Ae,{}),children:c("Previous")}),e.jsx(j,{colorScheme:"primary",onClick:h,children:c("Close")})]})]})}function Qe(n){const{isOpen:s,onClose:i}=n,{t:r}=b(),[d,m]=x.useState([]),[l,h]=x.useState({}),[c,u]=x.useState(""),[a,o]=x.useState({}),[t,p]=x.useState(!1),{companyConfig:S,templateList:z}=B(C=>C.app),v=B(C=>C.ticket),f=L.getCompanyEnglishName(v,S),H=L.getCompanyBlock(v),J=L.getTemplateBlocks(v);x.useEffect(()=>{if(s){m(L.getCompanyErrors(v)),h(L.getTemplateErrors(v));const C=L.getMajorUpdateNames(v,z).reduce((N,I)=>({...N,[I]:""}),{});o(C)}else u(""),o({}),p(!1)},[s]);const w=d.length>0||Object.values(l).flat().length>0,V=!w&&!t;return e.jsxs(de,{blockScrollOnMount:!1,isOpen:s,onClose:i,scrollBehavior:"inside",children:[e.jsx(pe,{}),e.jsxs(me,{children:[e.jsx(he,{children:r("Submit templates")}),e.jsx(ue,{}),w&&e.jsx(Ye,{companyErrors:d,templateErrors:l,onClose:i}),V&&e.jsx(Xe,{justification:c,majorUpdateJustifications:a,onJustificationChange:u,onMajorUpdateJustificationChange:(C,N)=>o(I=>({...I,[C]:N})),onNext:()=>p(!0)}),!w&&t&&e.jsx(Ke,{companyName:f,companyBlock:H,templateBlocks:J,justification:c,majorUpdateJustifications:a,onPrev:()=>p(!1),onClose:i})]})]})}const Ze={px:2,pt:2,width:{base:"100%",md:520},"& > div:first-of-type":{flexDirection:"column",flex:1,overflowY:"auto"},"& > div:nth-of-type(2)":{my:2}};function st(){const{t:n}=b(),s=Oe(),i=K(),[r,d]=x.useState(!1),m=()=>{F.isStandaloneWindow()?s("/"):F.openApp("rmg-templates")},l=()=>{i(Ie()),F.event(Ee.RESET_TICKETS,{})};return e.jsxs(Ne,{sx:Ze,children:[e.jsxs(_,{children:[e.jsx(Je,{}),e.jsx($e,{})]}),e.jsxs(_,{children:[e.jsx(j,{size:"sm",onClick:m,children:n("Back to list")}),e.jsxs(T,{ml:"auto",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:l,children:n("Reset")}),e.jsx(j,{size:"sm",colorScheme:"primary",onClick:()=>d(!0),children:n("Submit")})]})]}),e.jsx(Qe,{isOpen:r,onClose:()=>d(!1)})]})}export{st as default};
