import{ai as S,j as e,t as j,af as E,a2 as G,B as pe,ae as T,c as W,aj as ae,ak as q,N as O,al as me,L as Y,am as U,an as I,O as K,Q as he,ao as ue,R as fe,ap as xe,M as je,aq as ge,J as Ce,K as ve,h as ne}from"./chakra-wx10Q20x.js";import{L as z,S as J,d as X,u as D,e as ye,f as be,g as Se,h as Q,i as Z,c as ie,j as Oe,k as P,r as V,l as Me,a as Ie,m as we,n as se,o as Ne,p as ke,q as Re,t as Le,v as ze,w as Te,I as oe,x as le,G as Ee,y as N,R as Ae,z as Be,E as Fe}from"./index-BGwKFe7m.js";import{u as v,a as C,s as He}from"./react-CX09YTTM.js";import{u as A,R as k,a as Ue,b as re}from"./use-templates-DBnHBulH.js";function Pe(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"},child:[]}]})(t)}function Ve(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"},child:[]}]})(t)}function Je(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M19 19H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"},child:[]}]})(t)}function $(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"},child:[]}]})(t)}function De(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"},child:[]}]})(t)}function _e(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"},child:[]}]})(t)}function Ge(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"},child:[]}]})(t)}function $e(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"},child:[]}]})(t)}function We(t){return S({attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"},child:[]},{tag:"path",attr:{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"},child:[]}]})(t)}function ce(t){const{optionalName:a,onChange:s}=t,{t:r}=v(),o=A(),h=(n,i)=>[{type:"select",label:r("Language"),value:n,options:Object.entries(z).reduce((l,d)=>({...l,[d[0]]:o(d[1])}),{}),disabledOptions:Object.keys(z).filter(l=>J.includes(l)||a.some(d=>d[0]===l)).filter(l=>l!==n),onChange:l=>p(n,l)},{type:"input",label:r("Name"),value:i,onChange:l=>m(n,l),validator:l=>!!l}],c=()=>{const n=Object.keys(z).filter(i=>!J.includes(i)&&!a.some(l=>l[0]===i));n.includes("ko")?s([...a,["ko",""]]):s([...a,[n[0],""]])},p=(n,i)=>{s(a.map(l=>l[0]===n?[i,l[1]]:l))},m=(n,i)=>{s(a.map(l=>l[0]===n?[l[0],i]:l))},u=n=>{s(a.filter(i=>i[0]!==n))};return e.jsxs(e.Fragment,{children:[a.length===0&&e.jsx(j,{variant:"ghost",size:"sm",leftIcon:e.jsx($,{}),onClick:c,w:"100%",my:2,children:r("Add more translations")}),a.map(([n,i],l,d)=>e.jsxs(E,{sx:{w:"100%","& > div:first-of-type":{flex:1}},children:[e.jsx(k,{fields:h(n,i),noLabel:l>0}),l===d.length-1?e.jsx(G,{size:"sm",variant:"ghost","aria-label":r("Add translation"),title:r("Add translation"),onClick:c,icon:e.jsx($,{})}):e.jsx(pe,{minW:8}),e.jsx(G,{size:"sm",variant:"ghost","aria-label":r("Remove this translation"),title:r("Remove this translation"),onClick:()=>u(n),icon:e.jsx(Pe,{})})]},n))]})}function qe(){const{t}=v(),a=A(),s=X(),{company:r,newCompany:o,companyName:h,companyOptionalName:c}=D(n=>n.ticket),p=Ue(),m=[{type:"select",label:t("Company"),value:r,options:{...p,[t("New")]:{new:t("Add a company...")}},disabledOptions:[""],onChange:n=>s(ye(n))},{type:"input",label:t("Company code"),placeholder:"e.g. mtr, gzmtr, shmetro",value:o,onChange:n=>s(be(n)),hidden:r!=="new"}],u=J.map(n=>({type:"input",label:a(z[n]),value:h[n],onChange:i=>s(Se({lang:n,name:i}))}));return e.jsxs(Q,{children:[e.jsx(Z,{children:e.jsx(T,{as:"h5",size:"sm",children:t("Railway company")})}),e.jsx(W.div,{px:1,children:e.jsxs(ie,{direction:"column",children:[e.jsx(k,{fields:m}),r==="new"&&e.jsx(k,{fields:u}),r==="new"&&e.jsx(ce,{optionalName:c,onChange:n=>s(Oe(n))})]})})]})}const Ye=t=>new Promise(a=>{const s=new FileReader;s.onloadend=()=>a(s.result),s.readAsText(t)}),Ke={position:"relative","& > div":{overflow:"hidden"},"& > div:last-of-type":{flex:1,alignItems:"center",justifyContent:"center",minW:120,"& input":{display:"none"}}};function Xe(t){const{company:a,templateEntry:s,onLineChange:r,onNewLineChange:o,onMajorFlagChange:h,onLineNameChange:c,onOptionalNameChange:p,onParamChange:m,onParamImport:u,onRemove:n}=t,{line:i,newLine:l,majorUpdate:d,templateName:M,optionalName:g,param:B}=s,{t:x}=v(),F=A(),{templates:H}=re(a),w=C.useRef(null),_=async f=>{var ee;const b=(ee=f.target.files)==null?void 0:ee[0];if(console.log("handleFileUpload():: received file",b),!!b){if(b.type!=="application/json"){alert("Invalid file type!"),f.target.value="";return}try{const te=await Ye(b);m(JSON.parse(te))}catch(te){alert("Invalid file!"),f.target.value=""}}},y={"":x("Please select..."),...a===""||a==="new"?{}:H.reduce((f,b)=>({...f,[b.filename]:F(b.name)}),{}),new:x("Add a line...")},R=[{type:"select",label:x("Line"),value:i,options:y,disabledOptions:[""],onChange:f=>r(f),minW:150},{type:"input",label:x("Line code"),placeholder:"e.g. twl, gz1, sh1",value:l,onChange:f=>o(f),hidden:i!=="new"},{type:"custom",label:x("Major update"),component:e.jsx(P,{selections:[{label:x("Yes"),value:!0},{label:x("No"),value:!1}],defaultValue:d,onChange:f=>h(f)}),hidden:i==="new"}],L=J.map(f=>({type:"input",label:F(z[f]),value:M[f],onChange:b=>c(f,b)}));return e.jsxs(ie,{sx:Ke,children:[e.jsx(G,{size:"sm",variant:"ghost",icon:e.jsx(We,{}),"aria-label":x("Remove this line"),title:x("Remove this line"),position:"absolute",top:0,right:0,zIndex:5,onClick:n}),e.jsxs(ae,{spacing:0,children:[e.jsx(k,{fields:[...R,...L],minW:110}),e.jsx(ce,{optionalName:g,onChange:p})]}),e.jsx(ae,{children:B?e.jsxs(e.Fragment,{children:[e.jsx(q,{as:_e,boxSize:10}),e.jsxs(O,{as:"i",fontSize:"xs",children:["(",x("Size"),": ",JSON.stringify(B).length," ",x("chars"),")"]}),e.jsx(j,{size:"sm",onClick:()=>m(void 0),children:x("Remove")})]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{as:"i",fontSize:"sm",children:x("Import from")}),e.jsxs(E,{spacing:1,children:[e.jsx(j,{size:"sm",onClick:u,children:"RMG"}),e.jsx(j,{size:"sm",onClick:()=>{var f;return(f=w.current)==null?void 0:f.click()},children:x("Local")}),e.jsx("input",{ref:w,type:"file",accept:".json",onChange:_})]})]})})]})}const Qe="rmg-bridge--",Ze={h:500,maxH:"70%","& iframe":{h:"100%",w:"100%"}};function et(t){const{templateId:a,onClose:s,onImport:r}=t,[o]=C.useState(crypto.randomUUID()),h="/rmg/#/import?"+new URLSearchParams({parentComponent:V.getAppName(),parentId:o});return C.useEffect(()=>{const c=new BroadcastChannel(Qe+o);return c.onmessage=p=>{const{event:m,data:u}=p.data;console.log("[rmg-templates] Received event from RMG app clip:",m),m==="CLOSE"?s():m==="IMPORT"&&r(u)},()=>{c.close()}},[a]),e.jsx(Me,{isOpen:!!a,onClose:s,sx:Ze,children:e.jsx("iframe",{src:h,loading:"lazy"})})}function tt(){const{t}=v(),a=X(),{company:s,templates:r}=D(n=>n.ticket),{templates:o,isLoading:h}=re(s),[c,p]=C.useState(),m=(n,i)=>{const l=o.find(d=>d.filename===i);a(Te({id:n,line:i,name:l==null?void 0:l.name}))},u=n=>{c&&a(se({id:c,param:n})),p(void 0)};return e.jsxs(Q,{children:[h&&e.jsx(Ie,{isIndeterminate:!0}),e.jsxs(Z,{children:[e.jsx(T,{as:"h5",size:"sm",children:t("Add or update templates")}),e.jsx(me,{hasArrow:!0,label:t("Toggling on 'Major update' will update the uploader field of the template and you are required enter extra justification for it."),children:e.jsx("span",{children:e.jsx(q,{as:Ve,ml:1})})})]}),e.jsx(W.div,{px:1,transform:"translateZ(0)",children:r.map(n=>e.jsx(Xe,{company:s,templateEntry:n,onLineChange:i=>m(n.id,i),onNewLineChange:i=>a(Le({id:n.id,newLine:i})),onMajorFlagChange:i=>a(Re({id:n.id,majorUpdate:i})),onLineNameChange:(i,l)=>a(ke({id:n.id,lang:i,name:l})),onOptionalNameChange:i=>a(Ne({id:n.id,optionalName:i})),onParamChange:i=>a(se({id:n.id,param:i})),onParamImport:()=>p(n.id),onRemove:()=>a(we(n.id))},n.id))}),e.jsx(E,{justifyContent:"flex-end",children:e.jsx(j,{variant:"ghost",size:"sm",leftIcon:e.jsx($,{}),onClick:()=>a(ze()),children:t("Add item")})}),e.jsx(et,{templateId:c,onClose:()=>p(void 0),onImport:u})]})}function at(t){const{companyErrors:a,templateErrors:s,onClose:r}=t,{t:o}=v(),h=A();return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(O,{children:o("Your inputs contain the following errors. Please fix it before submitting.")}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(T,{as:"h5",size:"sm",my:2,children:o("Railway company")}),e.jsx(U,{"aria-label":"List of company errors",children:a.map((c,p)=>e.jsx(I,{children:h(oe[c])},p))})]}),Object.values(s).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(T,{as:"h5",size:"sm",my:2,children:o("Templates")}),e.jsx(U,{"aria-label":"List of template errors",children:Object.entries(s).map(([c,p])=>e.jsxs(I,{children:[c,e.jsx(U,{children:p.map((m,u)=>e.jsx(I,{children:h(oe[m])},u))})]},c))})]})]}),e.jsx(K,{children:e.jsx(E,{children:e.jsx(j,{colorScheme:"primary",onClick:r,children:o("Go back")})})})]})}const nt={hasDiagramInStation:!1,isOpened:!1,soonToBeOpened:!1,source:"",link:"",comments:"",majorUpdateComments:{}},st=()=>nt,de=t=>{const a=t.isOpened||t.soonToBeOpened;return t.hasDiagramInStation&&a},ot=t=>{const a=de(t),s=t.source==="STATION_UPLOAD_IMAGE"||t.source&&t.link,r=Object.values(t.majorUpdateComments).every(o=>!!o);return!!(a&&s&&t.comments&&r)},it=t=>{const{hasDiagramInStation:a,isOpened:s,soonToBeOpened:r,source:o,link:h,comments:c,majorUpdateComments:p}=t;return"| Item | Value |\n|---|---|\n| Route map in stations | ".concat(a?"Yes":"No"," |\n|    Opening status     | ").concat(s?"Opened":r?"To be opened":"Not yet opened"," |\n| Reference source type | ").concat(o?le[o].en:"Not selected"," |\n|     Reference link    | ").concat(h," |\n|     Justification     | ").concat(c.replaceAll("\n","<br>")," |\n").concat(Object.entries(p).map(([m,u])=>"| Major update of ".concat(m," | ").concat(u.replaceAll("\n","<br.")," |")).join("\n"))},lt=t=>{var a;return!!((a=t.match(/^https?:\/\//))!=null&&a[0])};function rt(t){const{justification:a,onJustificationUpdate:s,onNext:r}=t,{t:o}=v(),h=A(),c=[{label:o("Yes"),value:!0},{label:o("No"),value:!1}],p=Object.fromEntries([["",o("Please select...")],...Object.entries(le).map(([d,M],g)=>[d,"".concat(g+1,". ").concat(h(M))])]),m=[{type:"custom",label:o("Have all of the lines been officially opened?"),component:e.jsx(P,{selections:c,defaultValue:a.isOpened,onChange:d=>s("isOpened",d)})},{type:"custom",label:o("Are they soon to be opened? Are all of the station names finalised?"),component:e.jsx(P,{selections:c,defaultValue:a.soonToBeOpened,onChange:d=>s("soonToBeOpened",d)}),hidden:a.isOpened},{type:"custom",label:o("Is route map (network map) displayed in the stations of these lines?"),component:e.jsx(P,{selections:c,defaultValue:a.hasDiagramInStation,onChange:d=>s("hasDiagramInStation",d)})}],u=[{type:"select",label:o("Reference source"),options:p,disabledOptions:[""],value:a.source,onChange:d=>s("source",d)},{type:"input",value:a.link,label:o("Reference link"),placeholder:o("Enter a valid URL, e.g.")+" https://en.wikipedia.org",onChange:d=>s("link",d),validator:lt,isDisabled:a.source==="STATION_UPLOAD_IMAGE"},{type:"textarea",value:a.comments,label:o("Justification"),placeholder:o("Briefly describe your changes and provide justification"),onChange:d=>s("comments",d)}],n=Object.entries(a.majorUpdateComments).map(([d,M])=>({type:"textarea",value:M,label:o("Justification for major update of")+" "+d,placeholder:o("Briefly describe your changes and provide justification"),onChange:g=>s("majorUpdateComments",{...a.majorUpdateComments,[d]:g})})),i=de(a),l=ot(a);return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(O,{children:o("Please complete the questionnaire below.")}),e.jsx(k,{fields:m,minW:"full"}),i?e.jsxs(e.Fragment,{children:[e.jsx(O,{children:o("Please provide suitable source and justification.")}),e.jsx(k,{fields:[...u,...n],minW:"full"})]}):e.jsx(O,{as:"i",children:o("Sorry. The templates uploaded do not meet our acceptance criteria.")})]}),e.jsx(K,{children:e.jsx(j,{colorScheme:"primary",onClick:r,rightIcon:e.jsx($e,{}),isDisabled:!l,children:o("Next")})})]})}function ct(t){var l;const{companyName:a,companyBlock:s,templateBlocks:r,justification:o,onPrev:h,onClose:c}=t,{t:p}=v(),m=he("primary.500","primary.300"),u=[it(o),Ee,(l=s==null?void 0:s.outerHTML)!=null?l:"",...r.map(d=>d.outerHTML)].join("\n\n"),n=new URLSearchParams({template:"new-templates-request.md",labels:"resources",title:"Resources: New templates of "+a}),i=async()=>{await navigator.clipboard.writeText(u)};return e.jsxs(e.Fragment,{children:[e.jsxs(Y,{children:[e.jsx(O,{children:p("Follow the instructions below to open an Issue")+":"}),e.jsxs(ue,{children:[e.jsxs(I,{children:[p("Open")," ",e.jsxs(fe,{color:m,href:"https://github.com/railmapgen/rmg-templates/issues/new?"+n.toString(),isExternal:!0,children:["Issue: New Templates Request ",e.jsx(q,{as:Je})]})]}),e.jsxs(I,{children:[p("Click copy button and paste into issue body")," ",e.jsx(j,{size:"xs",leftIcon:e.jsx(De,{}),onClick:i,children:p("Copy")})]})]})]}),e.jsxs(K,{children:[e.jsx(j,{variant:"ghost",onClick:h,mr:"auto",leftIcon:e.jsx(Ge,{}),children:p("Previous")}),e.jsx(j,{colorScheme:"primary",onClick:c,children:p("Close")})]})]})}function dt(t){const{isOpen:a,onClose:s}=t,{t:r}=v(),[o,h]=C.useState([]),[c,p]=C.useState({}),[m,u]=C.useState(st()),[n,i]=C.useState(!1),{coreCompanyConfig:l,otherCompanyConfig:d,templateList:M}=D(y=>y.app),g=D(y=>y.ticket),B=N.getCompanyEnglishName(g,[...l,...d]),x=N.getCompanyBlock(g),F=N.getTemplateBlocks(g),H=(y,R)=>{u(L=>({...L,[y]:R}))};C.useEffect(()=>{if(a){h(N.getCompanyErrors(g)),p(N.getTemplateErrors(g));const y=N.getMajorUpdateNames(g,M).reduce((R,L)=>({...R,[L]:""}),{});H("majorUpdateComments",y)}else i(!1)},[a]);const w=o.length>0||Object.values(c).flat().length>0,_=!w&&!n;return e.jsxs(xe,{blockScrollOnMount:!1,isOpen:a,onClose:s,scrollBehavior:"inside",children:[e.jsx(je,{}),e.jsxs(ge,{children:[e.jsx(Ce,{children:r("Submit templates")}),e.jsx(ve,{}),w&&e.jsx(at,{companyErrors:o,templateErrors:c,onClose:s}),_&&e.jsx(rt,{justification:m,onJustificationUpdate:H,onNext:()=>i(!0)}),!w&&n&&e.jsx(ct,{companyName:B,companyBlock:x,templateBlocks:F,justification:m,onPrev:()=>i(!1),onClose:s})]})]})}function pt(){const{t}=v();return e.jsxs(Q,{children:[e.jsx(Z,{children:e.jsx(T,{as:"h5",size:"sm",children:t("Acceptance criteria")})}),e.jsxs(W.div,{px:5,children:[e.jsx(O,{children:t("acceptanceCriteria.preamble")}),e.jsxs(U,{children:[e.jsx(I,{children:t("acceptanceCriteria.item1")}),e.jsx(I,{children:t("acceptanceCriteria.item2")})]})]})]})}const mt={width:{base:"100%",md:520},alignSelf:"center","& > div:first-of-type":{flexDirection:"column",flex:1,overflowY:"auto",bg:"inherit"},"& > div:nth-of-type(2)":{my:2}};function jt(){const{t}=v(),a=He(),s=X(),[r,o]=C.useState(!1),h=()=>{V.isStandaloneWindow()?a("/"):V.openApp({appId:"rmg-templates"})},c=()=>{s(Be()),V.event(Fe.RESET_TICKETS,{})};return e.jsxs(Ae,{sx:mt,children:[e.jsxs(ne,{children:[e.jsx(pt,{}),e.jsx(qe,{}),e.jsx(tt,{})]}),e.jsxs(ne,{children:[e.jsx(j,{size:"sm",onClick:h,children:t("Back to list")}),e.jsxs(E,{ml:"auto",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:c,children:t("Reset")}),e.jsx(j,{size:"sm",colorScheme:"primary",onClick:()=>o(!0),children:t("Submit")})]})]}),e.jsx(dt,{isOpen:r,onClose:()=>o(!1)})]})}export{jt as default};
