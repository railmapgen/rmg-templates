import{a2 as M,j as e,d as v,Z as P,E as q,a3 as he,X as J,c as ie,a4 as ae,a5 as K,s as A,a6 as ue,r as Q,a7 as $,a8 as T,t as ee,v as fe,a9 as ge,L as je,aa as xe,M as ve,ab as Ce,p as ye,q as be,e as ne}from"./chakra-zRGELh8M.js";import{L as H,S as D,d as te,u as G,e as Se,f as Oe,g as Me,h as le,i as re,c as ce,j as Ne,k as X,r as V,l as we,a as Le,m as Ee,n as Re,o as ze,p as Ie,q as se,t as Be,v as ke,w as Te,I as oe,x as de,G as He,y as I,R as Ae,z as Fe,E as Pe}from"./index-lDPeBske.js";import{u as N,r as j,p as Ue}from"./react-3B37V2lT.js";import{u as B,R as F,a as Ve,b as pe}from"./use-templates-B0LjJqsr.js";function Je(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}}]})(n)}function De(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"}}]})(n)}function Ge(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"}}]})(n)}function Z(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}}]})(n)}function We(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"}}]})(n)}function _e(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"}}]})(n)}function Ye(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"}}]})(n)}function $e(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}}]})(n)}function qe(n){return M({tag:"svg",attr:{viewBox:"0 0 24 24"},child:[{tag:"path",attr:{fill:"none",d:"M0 0h24v24H0z"}},{tag:"path",attr:{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}}]})(n)}function me(n){const{optionalName:s,onChange:i}=n,{t:l}=N(),c=B(),h=(t,o)=>[{type:"select",label:l("Language"),value:t,options:Object.entries(H).reduce((a,g)=>({...a,[g[0]]:c(g[1])}),{}),disabledOptions:Object.keys(H).filter(a=>D.includes(a)||s.some(g=>g[0]===a)).filter(a=>a!==t),onChange:a=>p(t,a)},{type:"input",label:l("Name"),value:o,onChange:a=>m(t,a),validator:a=>!!a}],r=()=>{const t=Object.keys(H).filter(o=>!D.includes(o)&&!s.some(a=>a[0]===o));t.includes("ko")?i([...s,["ko",""]]):i([...s,[t[0],""]])},p=(t,o)=>{i(s.map(a=>a[0]===t?[o,a[1]]:a))},m=(t,o)=>{i(s.map(a=>a[0]===t?[a[0],o]:a))},f=t=>{i(s.filter(o=>o[0]!==t))};return e.jsxs(e.Fragment,{children:[s.length===0&&e.jsx(v,{variant:"ghost",size:"sm",leftIcon:e.jsx(Z,{}),onClick:r,w:"100%",my:2,children:l("Add more translations")}),s.map(([t,o],a,g)=>e.jsxs(P,{sx:{w:"100%","& > div:first-of-type":{flex:1}},children:[e.jsx(F,{fields:h(t,o),noLabel:a>0}),a===g.length-1?e.jsx(q,{size:"sm",variant:"ghost","aria-label":l("Add translation"),title:l("Add translation"),onClick:r,icon:e.jsx(Z,{})}):e.jsx(he,{minW:8}),e.jsx(q,{size:"sm",variant:"ghost","aria-label":l("Remove this translation"),title:l("Remove this translation"),onClick:()=>f(t),icon:e.jsx(Je,{})})]},t))]})}function Xe(){const{t:n}=N(),s=B(),i=te(),{company:l,newCompany:c,companyName:h,companyOptionalName:r}=G(t=>t.ticket),p=Ve(),m=[{type:"select",label:n("Company"),value:l,options:{...p,[n("New")]:{new:n("Add a company...")}},disabledOptions:[""],onChange:t=>i(Se(t))},{type:"input",label:n("Company code"),placeholder:"e.g. mtr, gzmtr, shmetro",value:c,onChange:t=>i(Oe(t)),hidden:l!=="new"}],f=D.map(t=>({type:"input",label:s(H[t]),value:h[t],onChange:o=>i(Me({lang:t,name:o}))}));return e.jsxs(le,{children:[e.jsx(re,{children:e.jsx(J,{as:"h5",size:"sm",children:n("Railway company")})}),e.jsx(ie.div,{px:1,children:e.jsxs(ce,{direction:"column",children:[e.jsx(F,{fields:m}),l==="new"&&e.jsx(F,{fields:f}),l==="new"&&e.jsx(me,{optionalName:r,onChange:t=>i(Ne(t))})]})})]})}const Ze=n=>new Promise(s=>{const i=new FileReader;i.onloadend=()=>s(i.result),i.readAsText(n)}),Ke={position:"relative","& > div":{overflow:"hidden"},"& > div:last-of-type":{flex:1,alignItems:"center",justifyContent:"center",minW:120,"& input":{display:"none"}}};function Qe(n){const{company:s,templateEntry:i,onLineChange:l,onNewLineChange:c,onMajorFlagChange:h,onLineNameChange:r,onOptionalNameChange:p,onParamChange:m,onParamImport:f,onRemove:t}=n,{line:o,newLine:a,majorUpdate:g,templateName:b,optionalName:w,param:S}=i,{t:d}=N(),y=B(),{templates:O}=pe(s),x=j.useRef(null),E=async u=>{var z;const C=(z=u.target.files)==null?void 0:z[0];if(console.log("handleFileUpload():: received file",C),!!C){if(C.type!=="application/json"){alert("Invalid file type!"),u.target.value="";return}try{const U=await Ze(C);m(JSON.parse(U))}catch(U){alert("Invalid file!"),u.target.value=""}}},k={"":d("Please select..."),...s===""||s==="new"?{}:O.reduce((u,C)=>({...u,[C.filename]:y(C.name)}),{}),new:d("Add a line...")},L=[{type:"select",label:d("Line"),value:o,options:k,disabledOptions:[""],onChange:u=>l(u),minW:150},{type:"input",label:d("Line code"),placeholder:"e.g. twl, gz1, sh1",value:a,onChange:u=>c(u),hidden:o!=="new"},{type:"custom",label:d("Major update"),component:e.jsx(X,{selections:[{label:d("Yes"),value:!0},{label:d("No"),value:!1}],defaultValue:g,onChange:u=>h(u)}),hidden:o==="new"}],W=D.map(u=>({type:"input",label:y(H[u]),value:b[u],onChange:C=>r(u,C)}));return e.jsxs(ce,{sx:Ke,children:[e.jsx(q,{size:"sm",variant:"ghost",icon:e.jsx(qe,{}),"aria-label":d("Remove this line"),title:d("Remove this line"),position:"absolute",top:0,right:0,zIndex:5,onClick:t}),e.jsxs(ae,{spacing:0,children:[e.jsx(F,{fields:[...L,...W],minW:110}),e.jsx(me,{optionalName:w,onChange:p})]}),e.jsx(ae,{children:S?e.jsxs(e.Fragment,{children:[e.jsx(K,{as:_e,boxSize:10}),e.jsxs(A,{as:"i",fontSize:"xs",children:["(",d("Size"),": ",JSON.stringify(S).length," ",d("chars"),")"]}),e.jsx(v,{size:"sm",onClick:()=>m(void 0),children:d("Remove")})]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{as:"i",fontSize:"sm",children:d("Import from")}),e.jsxs(P,{spacing:1,children:[e.jsx(v,{size:"sm",onClick:f,children:"RMG"}),e.jsx(v,{size:"sm",onClick:()=>{var u;return(u=x.current)==null?void 0:u.click()},children:d("Local")}),e.jsx("input",{ref:x,type:"file",accept:".json",onChange:E})]})]})})]})}const et="rmg-bridge--",tt={h:500,maxH:"70%","& iframe":{h:"100%",w:"100%"}};function at(n){const{templateId:s,onClose:i,onImport:l}=n,[c]=j.useState(crypto.randomUUID()),h="/rmg/#/import?"+new URLSearchParams({parentComponent:V.getAppName(),parentId:c});return j.useEffect(()=>{const r=new BroadcastChannel(et+c);return r.onmessage=p=>{const{event:m,data:f}=p.data;console.log("[rmg-templates] Received event from RMG app clip:",m),m==="CLOSE"?i():m==="IMPORT"&&l(f)},()=>{r.close()}},[s]),e.jsx(we,{isOpen:!!s,onClose:i,sx:tt,children:e.jsx("iframe",{src:h,loading:"lazy"})})}function nt(){const{t:n}=N(),s=te(),{company:i,templates:l}=G(t=>t.ticket),{templates:c,isLoading:h}=pe(i),[r,p]=j.useState(),m=(t,o)=>{const a=c.find(g=>g.filename===o);s(Te({id:t,line:o,name:a==null?void 0:a.name}))},f=t=>{r&&s(se({id:r,param:t})),p(void 0)};return e.jsxs(le,{children:[h&&e.jsx(Le,{isIndeterminate:!0}),e.jsxs(re,{children:[e.jsx(J,{as:"h5",size:"sm",children:n("Add or update templates")}),e.jsx(ue,{hasArrow:!0,label:n("Toggling on 'Major update' will update the uploader field of the template and you are required enter extra justification for it."),children:e.jsx("span",{children:e.jsx(K,{as:De,ml:1})})})]}),e.jsx(ie.div,{px:1,transform:"translateZ(0)",children:l.map(t=>e.jsx(Qe,{company:i,templateEntry:t,onLineChange:o=>m(t.id,o),onNewLineChange:o=>s(Ee({id:t.id,newLine:o})),onMajorFlagChange:o=>s(Re({id:t.id,majorUpdate:o})),onLineNameChange:(o,a)=>s(ze({id:t.id,lang:o,name:a})),onOptionalNameChange:o=>s(Ie({id:t.id,optionalName:o})),onParamChange:o=>s(se({id:t.id,param:o})),onParamImport:()=>p(t.id),onRemove:()=>s(Be(t.id))},t.id))}),e.jsx(P,{justifyContent:"flex-end",children:e.jsx(v,{variant:"ghost",size:"sm",leftIcon:e.jsx(Z,{}),onClick:()=>s(ke()),children:n("Add item")})}),e.jsx(at,{templateId:r,onClose:()=>p(void 0),onImport:f})]})}function st(n){const{companyErrors:s,templateErrors:i,onClose:l}=n,{t:c}=N(),h=B();return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx(A,{children:c("Your inputs contain the following errors. Please fix it before submitting.")}),s.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(J,{as:"h5",size:"sm",my:2,children:c("Railway company")}),e.jsx($,{"aria-label":"List of company errors",children:s.map((r,p)=>e.jsx(T,{children:h(oe[r])},p))})]}),Object.values(i).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx(J,{as:"h5",size:"sm",my:2,children:c("Templates")}),e.jsx($,{"aria-label":"List of template errors",children:Object.entries(i).map(([r,p])=>e.jsxs(T,{children:[r,e.jsx($,{children:p.map((m,f)=>e.jsx(T,{children:h(oe[m])},f))})]},r))})]})]}),e.jsx(ee,{children:e.jsx(P,{children:e.jsx(v,{colorScheme:"primary",onClick:l,children:c("Go back")})})})]})}function ot(n){const{haveBeenOpened:s,onHaveBeenOpenedChange:i,willBeOpened:l,onWillBeOpenedChange:c,refSource:h,onRefSourceChange:r,justification:p,majorUpdateJustifications:m,onJustificationChange:f,onMajorUpdateJustificationChange:t,onNext:o}=n,{t:a}=N(),g=B(),b=[{label:a("Yes"),value:!0},{label:a("No"),value:!1}],w=Object.fromEntries([["",a("Please select...")],...Object.entries(de).map(([x,E])=>[x,g(E)])]),S=[{type:"custom",label:a("Have all of the lines been officially opened?"),component:e.jsx(X,{selections:b,defaultValue:s,onChange:i})},{type:"custom",label:a("Will they be opened soon? Are all of the station names finalised?"),component:e.jsx(X,{selections:b,defaultValue:l,onChange:c}),hidden:s},{type:"select",label:a("Reference source"),options:w,disabledOptions:[""],value:h,onChange:x=>r(x)},{type:"textarea",value:p,label:a("Justification"),placeholder:a("Briefly describe your changes and provide justification"),onChange:f}],d=Object.entries(m).map(([x,E])=>({type:"textarea",value:E,label:a("Justification for major update of")+" "+x,placeholder:a("Briefly describe your changes and provide justification"),onChange:k=>t(x,k)})),O=!(s||l)||!h||!p||Object.values(m).some(x=>!x);return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx(A,{children:a("Please provide suitable source and justification.")}),e.jsx(F,{fields:[...S,...d],minW:"full"})]}),e.jsx(ee,{children:e.jsx(v,{colorScheme:"primary",onClick:o,rightIcon:e.jsx($e,{}),isDisabled:O,children:a("Next")})})]})}function it(n){var d;const{companyName:s,companyBlock:i,templateBlocks:l,haveBeenOpened:c,willBeOpened:h,refSource:r,justification:p,majorUpdateJustifications:m,onPrev:f,onClose:t}=n,{t:o}=N(),a=B(),g=fe("primary.500","primary.300"),b=["**Lines opening status:** ".concat(c?"OPENED":h?"WILL BE OPENED SOON":"NOT READY FOR OPENING"),"**Reference source:** ".concat(r?a(de[r]):"(REPLACE ME)"),"**Justification:** ".concat(p||"(REPLACE ME)"),Object.entries(m).map(([y,O])=>"- Major update of ".concat(y,": ").concat(O)).join("\n"),He,(d=i==null?void 0:i.outerHTML)!=null?d:"",...l.map(y=>y.outerHTML)].join("\n\n"),w=new URLSearchParams({template:"new-templates-request.md",labels:"resources",title:"Resources: New templates of "+s}),S=async()=>{await navigator.clipboard.writeText(b)};return e.jsxs(e.Fragment,{children:[e.jsxs(Q,{children:[e.jsx(A,{children:o("Follow the instructions below to open an Issue")+":"}),e.jsxs(ge,{children:[e.jsxs(T,{children:[o("Open")," ",e.jsxs(je,{color:g,href:"https://github.com/railmapgen/rmg-templates/issues/new?"+w.toString(),isExternal:!0,children:["Issue: New Templates Request ",e.jsx(K,{as:Ge})]})]}),e.jsxs(T,{children:[o("Click copy button and paste into issue body")," ",e.jsx(v,{size:"xs",leftIcon:e.jsx(We,{}),onClick:S,children:o("Copy")})]})]})]}),e.jsxs(ee,{children:[e.jsx(v,{variant:"ghost",onClick:f,mr:"auto",leftIcon:e.jsx(Ye,{}),children:o("Previous")}),e.jsx(v,{colorScheme:"primary",onClick:t,children:o("Close")})]})]})}function lt(n){const{isOpen:s,onClose:i}=n,{t:l}=N(),[c,h]=j.useState([]),[r,p]=j.useState({}),[m,f]=j.useState(!1),[t,o]=j.useState(!1),[a,g]=j.useState(""),[b,w]=j.useState(""),[S,d]=j.useState({}),[y,O]=j.useState(!1),{coreCompanyConfig:x,otherCompanyConfig:E,templateList:k}=G(R=>R.app),L=G(R=>R.ticket),W=I.getCompanyEnglishName(L,[...x,...E]),u=I.getCompanyBlock(L),C=I.getTemplateBlocks(L);j.useEffect(()=>{if(s){h(I.getCompanyErrors(L)),p(I.getTemplateErrors(L));const R=I.getMajorUpdateNames(L,k).reduce((_,Y)=>({..._,[Y]:""}),{});d(R)}else f(!1),o(!1),g(""),w(""),d({}),O(!1)},[s]);const z=c.length>0||Object.values(r).flat().length>0,U=!z&&!y;return e.jsxs(xe,{blockScrollOnMount:!1,isOpen:s,onClose:i,scrollBehavior:"inside",children:[e.jsx(ve,{}),e.jsxs(Ce,{children:[e.jsx(ye,{children:l("Submit templates")}),e.jsx(be,{}),z&&e.jsx(st,{companyErrors:c,templateErrors:r,onClose:i}),U&&e.jsx(ot,{haveBeenOpened:m,onHaveBeenOpenedChange:f,willBeOpened:t,onWillBeOpenedChange:o,refSource:a,onRefSourceChange:g,justification:b,majorUpdateJustifications:S,onJustificationChange:w,onMajorUpdateJustificationChange:(R,_)=>d(Y=>({...Y,[R]:_})),onNext:()=>O(!0)}),!z&&y&&e.jsx(it,{companyName:W,companyBlock:u,templateBlocks:C,haveBeenOpened:m,willBeOpened:t,refSource:a,justification:b,majorUpdateJustifications:S,onPrev:()=>O(!1),onClose:i})]})]})}const rt={width:{base:"100%",md:520},alignSelf:"center","& > div:first-of-type":{flexDirection:"column",flex:1,overflowY:"auto",bg:"inherit"},"& > div:nth-of-type(2)":{my:2}};function ht(){const{t:n}=N(),s=Ue(),i=te(),[l,c]=j.useState(!1),h=()=>{V.isStandaloneWindow()?s("/"):V.openApp("rmg-templates")},r=()=>{i(Fe()),V.event(Pe.RESET_TICKETS,{})};return e.jsxs(Ae,{sx:rt,children:[e.jsxs(ne,{children:[e.jsx(Xe,{}),e.jsx(nt,{})]}),e.jsxs(ne,{children:[e.jsx(v,{size:"sm",onClick:h,children:n("Back to list")}),e.jsxs(P,{ml:"auto",children:[e.jsx(v,{size:"sm",variant:"outline",onClick:r,children:n("Reset")}),e.jsx(v,{size:"sm",colorScheme:"primary",onClick:()=>c(!0),children:n("Submit")})]})]}),e.jsx(lt,{isOpen:l,onClose:()=>c(!1)})]})}export{ht as default};
